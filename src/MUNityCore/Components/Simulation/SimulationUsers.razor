@inject Services.SimulationService simulationService;
@inject Services.FrontendSimulationService frontendSimulationService;

<div class="col-lg-12 col-md-12">
    <div class="card border-0 text-truncate mb-3 bg-dark text-white">
        <!-- begin card-body -->
        <div class="card-body">
            <!-- begin title -->
            <div class="mb-3 text-grey">
                <b class="mb-3">Benutzer</b>
                <span class="ml-2"><i class="fa fa-info-circle" data-toggle="popover" data-trigger="hover" data-title="Conversion Rate" data-placement="top" data-content="Percentage of sessions that resulted in orders from total number of sessions." data-original-title="" title=""></i></span>
            </div>
            <!-- end title -->
            <!-- begin conversion-rate -->
            <div class="d-flex align-items-center mb-1">
                <h2 class="text-white mb-0">@users.Count(n => n.IsOnline) Online</h2>
                <div class="ml-auto" style="position: relative;">
                    @*<p>Right Text</p>*@
                </div>
            </div>
            <!-- end conversion-rate -->
            <!-- begin percentage -->
            <div class="mb-4 text-grey">
                @users.Count Insgesamt
            </div>

            <div class="d-flex mb-2">
                <div class="d-flex align-items-center">
                    <b>Vorsitz</b>
                </div>
            </div>

            @foreach (var chair in users.Where(n => n.RoleType == MUNity.Schema.Simulation.RoleTypes.Chairman))
            {
                <div class="d-flex mb-2">
                    <div class="d-flex align-items-center">
                        <i class="fa fa-circle @((chair.IsOnline) ? "text-lime" : "text-red") f-s-8 mr-2"></i>
                        <img src="img/flags/small/un.png" class="m-r-5" />
                        @chair.RoleName (@chair.DisplayName)
                    </div>
                    <div class="d-flex align-items-center ml-auto">
                        <div class="text-grey f-s-11"><i class="fa fa-caret-up"></i> <span data-animation="number" data-value="262">262</span>%</div>
                        <div class="width-50 text-right pl-2 f-w-600"><span data-animation="number" data-value="3.79">3.79</span>%</div>
                    </div>
                </div>
            }

            <div class="d-flex mb-2">
                <div class="d-flex align-items-center">
                    <b>Delegierte</b>
                </div>
            </div>

            @foreach (var del in users.Where(n => n.RoleType == MUNity.Schema.Simulation.RoleTypes.Delegate))
            {
                <div class="d-flex mb-2">
                    <div class="d-flex align-items-center">
                        <i class="fa fa-circle @((del.IsOnline) ? "text-lime" : "text-red") f-s-8 mr-2"></i>
                        <img src="img/flags/small/@(del.RoleIso).png" class="m-r-5" />
                        @del.RoleName (@del.DisplayName)
                    </div>
                    <div class="d-flex align-items-center ml-auto">
                        <div class="text-grey f-s-11"><i class="fa fa-caret-up"></i> <span data-animation="number" data-value="262">262</span>%</div>
                        <div class="width-50 text-right pl-2 f-w-600"><span data-animation="number" data-value="3.79">3.79</span>%</div>
                    </div>
                </div>
            }

            <div class="d-flex mb-2">
                <div class="d-flex align-items-center">
                    <b>Nichtstaatliche Akteure</b>
                </div>
            </div>

            @foreach (var na in users.Where(n => n.RoleType == MUNity.Schema.Simulation.RoleTypes.Ngo))
            {
                <div class="d-flex mb-2">
                    <div class="d-flex align-items-center">
                        <i class="fa fa-circle @((na.IsOnline) ? "text-lime" : "text-red") f-s-8 mr-2"></i>
                       @na.RoleName (@na.DisplayName)
                    </div>
                    <div class="d-flex align-items-center ml-auto">
                        <div class="text-grey f-s-11"><i class="fa fa-caret-up"></i> <span data-animation="number" data-value="262">262</span>%</div>
                        <div class="width-50 text-right pl-2 f-w-600"><span data-animation="number" data-value="3.79">3.79</span>%</div>
                    </div>
                </div>
            }

            <div class="d-flex mb-2">
                <div class="d-flex align-items-center">
                    <b>Weitere</b>
                </div>
            </div>

            @foreach (var na in users.Where(n => n.RoleType == MUNity.Schema.Simulation.RoleTypes.None || 
             n.RoleType == MUNity.Schema.Simulation.RoleTypes.Spectator))
            {
                <div class="d-flex mb-2">
                    <div class="d-flex align-items-center">
                        <i class="fa fa-circle @((na.IsOnline) ? "text-lime" : "text-red") f-s-8 mr-2"></i>
                        @na.DisplayName @(string.IsNullOrEmpty(na.RoleName) ? "" : "- " + na.RoleName)
                    </div>
                    <div class="d-flex align-items-center ml-auto">
                        <div class="text-grey f-s-11"><i class="fa fa-caret-up"></i> <span data-animation="number" data-value="262">262</span>%</div>
                        <div class="width-50 text-right pl-2 f-w-600"><span data-animation="number" data-value="3.79">3.79</span>%</div>
                    </div>
                </div>
            }
        </div>
        <!-- end card-body -->
    </div>
</div>



@code {
    [Parameter]
    public int SimulationId { get; set; }

    private List<MUNityCore.Dtos.Simulations.SimulationUserInfoDto> users;

    protected override void OnInitialized()
    {
        users = simulationService.GetSimulationUserInfos(SimulationId);
        this.frontendSimulationService.ConnectedUsersChanged += ConnectedUsersChanged;
        base.OnInitialized();
    }

    private void ConnectedUsersChanged(object sender, List<int> connectedUsers)
    {
        Console.WriteLine("Connected users changed!");
        foreach(var user in users)
        {
            user.IsOnline = connectedUsers.Contains(user.SimulationUserId);
        }
        this.InvokeAsync(() => this.StateHasChanged());
    }
}
