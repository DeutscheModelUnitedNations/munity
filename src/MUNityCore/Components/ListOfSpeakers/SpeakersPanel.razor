@inject Services.FrontendSimulationService frontendSimulationService;
@inject Services.SpeakerlistService speakerlistService;
@inject Services.SpeakerlistHubService speakerlistHubService;

<div class="card border-0 text-truncate mb-3 bg-dark text-white">
    <div class="card-body">
        <div class="mb-3 text-grey">
            <b>Redeliste</b>
            @if (this.frontendSimulationService.IsChair)
            {
                <button class="btn btn-sm btn-circle @resumeSpeakerButtonClass"
                        @onclick="() => ToggleSpeaking()">
                    <i class="fa @((ListOfSpeakers.Status == MUNity.Models.ListOfSpeakers.ListOfSpeakers.EStatus.Speaking) ? "fa-pause" : "fa-play") "></i>
                </button>
                <button class="btn btn-sm btn-circle btn-primary"
                        @onclick="() => NextSpeaker()">
                    <i class="fa fa-step-forward"></i>
                </button>
                @if (ListOfSpeakers.CurrentSpeaker != null)
                {
                    <button class="btn btn-sm btn-circle btn-danger"
                            @onclick="() => ClearSpeaker()">
                        <i class="fa fa-times"></i>
                    </button>
                }
            }
        </div>
        <div class="d-flex align-items-center mb-1">
            <h2 class="text-white mb-0">@((ListOfSpeakers.CurrentSpeaker != null) ? ListOfSpeakers.CurrentSpeaker.Name : "Niemand")</h2>
            <div class="ml-auto" style="position: relative;">
                <a href="javascript:;" title="Auf die Redeliste setzen"
                   class="btn btn-icon btn-circle @((isOnSpeakerlist) ? "btn-default disabled" : "btn-success")"
                   @onclick="() => AddMeToSpeakerlist()">
                    <i class="fa fa-plus"></i>
                </a>
            </div>
        </div>

        <div class="stats-progress progress bg-secondary" style="height: 2px;">
            <div class="progress-bar" style="width: @(RemainingSpeakerTimePercentage)%;"></div>
        </div>


        <div class="mb-4 text-grey">
            <i class="fa fa-clock"></i>
            @if (ListOfSpeakers.RemainingSpeakerTime.TotalSeconds > 0)
            {
                <span>@ListOfSpeakers.RemainingSpeakerTime.ToString(@"mm\:ss") verbleibend</span>
            }
            else
            {
                @if (frontendSimulationService.IsChair)
                {
                    <span class="text-red">@ListOfSpeakers.RemainingSpeakerTime.ToString(@"mm\:ss") überzogen</span>
                }
                else
                {
                    <span class="text-red">Bitte zum Ende kommen!</span>
                }

            }
        </div>
        @foreach (var waitingSpeaker in ListOfSpeakers.Speakers)
        {
    <div class="d-flex mb-2">
        <div class="d-flex align-items-center">
            @waitingSpeaker.Name
        </div>
        @if (this.frontendSimulationService.IsChair)
        {
            <div class="d-flex align-items-center ml-auto">
                <button class="btn btn-sm btn-circle btn-danger"
                        @onclick="() => RemoveSpeaker(waitingSpeaker)">
                    <i class="fa fa-trash"></i>
                </button>
            </div>
        }

    </div>
        }

    </div>
</div>

@code {
    [Parameter]
    public MUNity.Models.ListOfSpeakers.ListOfSpeakers ListOfSpeakers { get; set; }

    private System.Timers.Timer refreshTimer;

    public double RemainingSpeakerTimePercentage
    {
        get
        {
            if (this.ListOfSpeakers.SpeakerTime.TotalSeconds == 0) return 0;
            return Math.Round(this.ListOfSpeakers.RemainingSpeakerTime.TotalSeconds * 100 / this.ListOfSpeakers.SpeakerTime.TotalSeconds);
        }
    }

    private string resumeSpeakerButtonClass
    {
        get
        {
            if (ListOfSpeakers.CurrentSpeaker == null) return "disabled btn-default";
            if (ListOfSpeakers.Status == MUNity.Models.ListOfSpeakers.ListOfSpeakers.EStatus.Speaking ||
                ListOfSpeakers.Status == MUNity.Models.ListOfSpeakers.ListOfSpeakers.EStatus.Answer)
                return "btn-warning";

            return "btn-success";
        }
    }

    private bool isOnSpeakerlist => ListOfSpeakers.Speakers.Any(n => n.Name == this.frontendSimulationService.CurrentRoleName);

    private void ClearSpeaker()
    {
        this.speakerlistHubService.ClearSpeaker(this.ListOfSpeakers);
    }

    private async Task AddMeToSpeakerlist()
    {
        await this.frontendSimulationService.AddMeToSpeakerlist();
    }

    private void NextSpeaker()
    {
        this.speakerlistHubService.NextSpeaker(this.ListOfSpeakers);
    }

    private void ToggleSpeaking()
    {
        if (this.ListOfSpeakers.Status == MUNity.Models.ListOfSpeakers.ListOfSpeakers.EStatus.Speaking ||
        this.ListOfSpeakers.Status == MUNity.Models.ListOfSpeakers.ListOfSpeakers.EStatus.Answer)
        {
            this.speakerlistHubService.Pause(this.ListOfSpeakers);
        }
        else
        {
            this.speakerlistHubService.ResumeSpeaker(this.ListOfSpeakers);
        }
    }

    private async Task RemoveSpeaker(MUNity.Models.ListOfSpeakers.Speaker speaker)
    {
        await this.speakerlistHubService.RemoveSpeaker(this.ListOfSpeakers, speaker.Id);
    }

    protected override void OnInitialized()
    {
        this.refreshTimer = new System.Timers.Timer(1000);
        this.refreshTimer.Elapsed += delegate { RefreshView(); };
        this.refreshTimer.Start();
        base.OnInitialized();
    }

    private void RefreshView()
    {
        if (this.ListOfSpeakers.Status == MUNity.Models.ListOfSpeakers.ListOfSpeakers.EStatus.Speaking ||
            this.ListOfSpeakers.Status == MUNity.Models.ListOfSpeakers.ListOfSpeakers.EStatus.Answer)
        {
            InvokeAsync(this.StateHasChanged);
        }
    }
}
