@using MUNity.Extensions.ResolutionExtensions
@using MUNityCore.Dtos.Resolutions;

@inject Services.SqlResolutionService resolutionService;

@if (ViewModel != null)
{
    <div class="panel panel-inverse" data-sortable-id="ui-widget-1" style="">
        <div class="panel-heading ui-sortable-handle">
            <h4 class="panel-title">Änderungsanträge <span class="badge badge-primary">@ViewModel.Resolution.OperativeSection.AmendmentCount()</span></h4>
            @*<div class="panel-heading-btn">

                <a class="btn btn-xs btn-icon btn-circle btn-primary"><i class="fa fa-arrow-circle-right"></i></a>
            </div>*@
        </div>
        <div class="panel-body bg-white-darker">
            <button class="btn btn-block btn-success mb-2"
                    @onclick="() => createModal?.ShowModal()">
                Neuer Änderungsantrag
            </button>
            @foreach (var amendment in ViewModel.Resolution.OperativeSection.GetOrderedAmendments())
            {
                <div class="card border-0 text-truncate mb-3 bg-dark text-white">
                    <!-- begin card-body -->
                    <div class="card-body">
                        <!-- begin title -->
                        <div class="mb-3 text-grey">
                            <b class="mb-3">
                                @((amendment is MUNity.Models.Resolution.AddAmendment) ? "Hinzufügen eines Absatzes" : null)
                                @((amendment is MUNity.Models.Resolution.ChangeAmendment) ? "Textänderung" : null)
                                @((amendment is MUNity.Models.Resolution.DeleteAmendment) ? "Streichen eines Absatzes" : null)
                                @((amendment is MUNity.Models.Resolution.MoveAmendment) ? "Verschieben eines Absatzes" : null)

                                @if (amendment is MUNity.Models.Resolution.ChangeAmendment changeAmendment)
                                {
                                    var targetParagrapg = ViewModel.Resolution.OperativeSection.FindOperativeParagraph(changeAmendment.TargetSectionId);
                                    if (targetParagrapg != null)
                                    {
                                        <span>@MUNityCore.Util.Tools.StringComputation.LevenshteinDistance(targetParagrapg.Text, changeAmendment.NewText) Levenshtein-Distance</span>
                                        <span>@Math.Round(MUNityCore.Util.Tools.StringComputation.StringDiff(targetParagrapg.Text, changeAmendment.NewText)) % Ähnlichkeit</span>
                                    }
                                }

                            </b>
                        </div>
                        <!-- end title -->
                        <!-- begin conversion-rate -->
                        <div class="d-flex align-items-center mb-1">
                            @if (amendment is MUNity.Models.Resolution.AddAmendment)
                            {
                                <h2>Virtual</h2>
                            }
                            else
                            {
                                <h2 class="text-white mb-0">Absatz: @ViewModel.Resolution.OperativeSection.GetIndexNameOfOperativeParagraph(amendment.TargetSectionId)</h2>
                            }

                            <div class="ml-auto" style="position: relative;">

                                <h3>
                                    @if (amendment.Activated)
                                    {
                                        <i class="fa fa-eye primary" style="cursor: pointer;" @onclick="() => ViewModel.DeactivateAmendment(amendment.Id)"></i>
                                    }
                                    else
                                    {
                                        <i class="fa fa-eye-slash" style="cursor: pointer;" @onclick="() => ViewModel.ActivateAmendment(amendment.Id)"></i>
                                    }

                                </h3>
                            </div>
                        </div>

                        @if (amendment is MUNity.Models.Resolution.ChangeAmendment ca)
                        {
                            <div class="mb-4 text-grey text-wrap">
                                Neuer Text: @ca.NewText
                            </div>
                        }
                        else if (amendment is MUNity.Models.Resolution.AddAmendment aa)
                        {
                            <div class="mb-4 text-grey text-wrap">
                                Text: @ViewModel.Resolution.OperativeSection.FindOperativeParagraph(aa.TargetSectionId)?.Text;
                            </div>
                        }

                        <div class="mb-4 text-grey">
                            <i class="fa fa-flag"></i> @amendment.SubmitterName (@amendment.SubmitTime.ToString("dd.MM HH:mm"))
                        </div>

                        <div class="d-flex mb-2">
                            <button class="btn btn-block btn-outline-success"
                                    @onclick="() => SubmitAmendment(amendment)">
                                Annehmen
                            </button>
                        </div>

                        <div class="d-flex mb-2">
                            <button class="btn btn-block btn-outline-danger"
                                    @onclick="() => DenyAmendment(amendment)">
                                Ablehnen
                            </button>
                        </div>
                    </div>
                    <!-- end card-body -->
                </div>
            }
        </div>
    </div>
}
else
{
    <p>Lade Änderungsanträge</p>
}

<CreateAmendmentModal @ref="@createModal" ViewModel="@ViewModel" AmendmentCreated="OnAmendmentCreated" />


@code {
    [Parameter]
    public ViewModel.ResolutionViewModel ViewModel { get; set; }

    [Parameter]
    public EventCallback<MUNity.Models.Resolution.AbstractAmendment> AmendmentSubmitted { get; set; }

    [Parameter]
    public EventCallback<MUNity.Models.Resolution.AbstractAmendment> AmendmentDenied { get; set; }

    [Parameter]
    public EventCallback AmendmentChanged { get; set; }

    private CreateAmendmentModal createModal;

    protected override void OnInitialized()
    {
        base.OnInitialized();
        if (this.ViewModel != null)
        {
            this.ViewModel.ChangedFromExtern += delegate { InvokeAsync(StateHasChanged); };
            }
    }

    private void OnAmendmentCreated()
    {
        this.AmendmentChanged.InvokeAsync();
    }

    private async Task SubmitAmendment(MUNity.Models.Resolution.AbstractAmendment amendment)
    {
        await this.ViewModel.SubmitAmendment(amendment);
    }

    private async Task DenyAmendment(MUNity.Models.Resolution.AbstractAmendment amendment)
    {
        await this.ViewModel.RemoveAmendment(amendment);
    }
}
